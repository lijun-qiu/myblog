---
title: ç¬¬å…­æ¬¡åˆ†äº«
date: 2024-07-19
tags:
 - ç¬¬å…­æ¬¡åˆ†äº«
categories:
 - ç¬¬å…­æ¬¡åˆ†äº«
---

## 1å‰ç«¯é¡¹ç›®éƒ¨ç½²åæé†’æ­£åœ¨è®¿é—®çš„ç”¨æˆ·åˆ·æ–°é¡µé¢
æµ‹è¯•æäº†ä¸ªbugï¼Œæˆ‘ä»¬ä¿®æ”¹å¥½åé‡æ–°éƒ¨ç½²åˆ°ç¯å¢ƒä¸Šäº†ï¼Œè®©æµ‹è¯•å»æµ‹ä¸‹ï¼Œæµ‹è¯•æœ‰æ—¶ä¼šè¯´ï¼Œä¸æ˜¯ï¼Œå“¥ä»¬ï¼Œå’‹è¿˜æ˜¯æœ‰é—®é¢˜å‘¢ï¼Œä½ ç¡®å®šå¤„ç†å¥½äº†ï¼Ÿä½ å¯èƒ½å°±ä¼šè¯´ï¼Œåˆ·æ–°ä¸‹é¡µé¢å†è¯•ä¸‹å‘¢ã€‚åˆ·æ–°ï¼Œokokï¼Œå¯ä»¥äº†ã€‚    
### å®ç°æ€è·¯
æ‰“å¼€ç½‘ç«™ã€æˆ–åˆ·æ–°ç½‘ç«™æ—¶ï¼Œè¯»å–ç½‘ç«™èµ„æºçš„Etagæˆ–last-modifyä¿¡æ¯ï¼Œä½¿ç”¨ä¸´æ—¶å˜é‡å­˜å‚¨ï¼Œè¿™å‘½åä¸ºpreTag
è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯é—´éš”å¤šå°‘ç§’ï¼Œé‡æ–° è¯»å–å–ç½‘ç«™èµ„æºçš„Etagæˆ–last-modifyä¿¡æ¯ï¼Œè¿™å‘½åä¸ºcurTag
å¯¹æ¯”preTagå’ŒcurTagï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™å¼¹å‡ºæç¤ºä¿¡æ¯ï¼Œæé†’ç”¨æˆ·æœ‰ç‰ˆæœ¬æ›´æ–°ï¼Œè¯·ç”¨æˆ·åˆ·æ–°é¡µé¢
### ä»£ç å®ç°
```js
import { ElNotification } from "element-plus";

const LOOPER_TIME = 5 * 1000; // æ£€æµ‹ç‰ˆæœ¬æ›´æ–°çš„è½®è®­æ—¶é—´

let preTag: string | null; // ç”¨äºè®°å½•åˆæ¬¡è¿›å…¥ç½‘ç«™æˆ–ç½‘ç«™è¢«åˆ·æ–°æ—¶çš„Etagä¿¡æ¯

if (process.env.NODE_ENV !== "development") {
  // åªåœ¨ç”Ÿæˆç¯å¢ƒç”Ÿæ•ˆ
  (async () => {
    preTag = await getTag();

    // æ¯éš”ä¸€æ®µæ—¶é—´è·å–ä¸€éç½‘ç«™çš„etagä¿¡æ¯ï¼Œä¸preTagåšå¯¹æ¯”ï¼Œå¦‚æœä¸ä¸€æ ·ï¼Œåˆ™è¯æ˜æœ‰ç‰ˆæœ¬æ›´æ–°
    const interval = setInterval(async () => {
      const curTag = await getTag();
      if (preTag !== curTag) {
        showNotification();
        clearInterval(interval);
        preTag = curTag
      }
    }, LOOPER_TIME);
  })()
}

/**
 * æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°åï¼Œnotificationä¼šä¸€ç›´æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
 */
function showNotification(): void {
  ElNotification({
    showClose: false,
    duration: 0,
    title: "ç‰ˆæœ¬æ›´æ–°æç¤º",
    dangerouslyUseHTMLString: true,
    message:
      "æ£€æµ‹åˆ°æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒï¼Œè¯·<a href='javascript:location.reload()'>åˆ·æ–°</a>é¡µé¢",
  });
}

/**
 * è·å–ç½‘ç«™èµ„æºçš„Etagä¿¡æ¯
 *
 * @returns ç½‘ç«™èµ„æºçš„Etagä¿¡æ¯
 */
async function getTag(): Promise<string | null> {
  const response = await fetch(window.location.origin, {
    method: "HEAD", // ç”¨äºè·å–èµ„æºçš„å…ƒæ•°æ®ï¼Œä¸GETè¯·æ±‚ç±»ä¼¼ï¼ŒHEADè¯·æ±‚ä¹ŸåƒæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä½†æœåŠ¡å™¨åªéœ€è¦å›ä¼ èµ„æºçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä¸éœ€è¦å›ä¼ èµ„æºçš„å®ä½“ä¸»ä½“ã€‚
    cache: "no-cache",
  });
  return response.headers.get("Etag") || response.headers.get("last-modified");
}
```

## 2å‰ç«¯æ€§èƒ½ä¼˜åŒ–ï¼šåŠ«æŒPromise
```js
import isEqual from 'lodash/isEqual';

function promiseHijack(promiseFn, options = { isEqual: isEqual }) {
  const pendingMap = new Map();

  return function (...args) {
    const targetArguments = Array.from(pendingMap.keys()).find(key => options.isEqual(key, args));
    const targetValue = pendingMap.get(targetArguments);

    if (targetArguments && targetValue) {
      return new Promise((resolve, reject) => {
        targetValue.push({ resolve, reject });
      });
    }

    return new Promise((resolve, reject) => {
      pendingMap.set(args, [{ resolve, reject }]);
    }).then(() => {
      promiseFn.apply(null, args).then(
        value => {
          targetValue.forEach(({ resolve }) => resolve(value));
          pendingMap.delete(args);
        },
        error => {
          targetValue.forEach(({ reject }) => reject(error));
          pendingMap.delete(args);
        }
      );
    });
  };
}
export default promiseHijack;
```
### ä½¿ç”¨
æ¨¡æ‹Ÿè€—æ—¶çš„promiseæ“ä½œ
```js
const delay = ms => new Promise(resolve => setTimeout(() => resolve(), ms));

let count = 1;
const mockApi = async (name) => {
    console.log("ğŸ‘» ~ mockApi ~ running");
    await delay(1000);
    return `${name}-timestamp-${count++}`
}
```
1ã€è¢«åŠ«æŒçš„æƒ…å†µ  
ä¸ä½¿ç”¨promiseHijack
```js
count = 1;
mockApi().then((data) => console.log("mockApi_1:", data));
mockApi().then((data) => console.log("mockApi_2:", data));
mockApi().then((data) => console.log("mockApi_3:", data));

// ğŸ‘» ~ mockApi ~ running
// ğŸ‘» ~ mockApi ~ running
// ğŸ‘» ~ mockApi ~ running

// mockApi_1: undefined-timestamp-1
// mockApi_2: undefined-timestamp-2
// mockApi_3: undefined-timestamp-3
```
ä½¿ç”¨promiseHijack
```js
count = 1;
const hijackedMockApi = promiseHijack(mockApi);
hijackedMockApi().then((data) => console.log("hijackedMockApi_1:", data));
hijackedMockApi().then((data) => console.log("hijackedMockApi_2:", data));
hijackedMockApi().then((data) => console.log("hijackedMockApi_3:", data));

// ğŸ‘» ~ mockApi ~ running

// hijackedMockApi_1: undefined-timestamp-1
// hijackedMockApi_2: undefined-timestamp-1
// hijackedMockApi_3: undefined-timestamp-1
```
åˆ†æï¼š  
æœªä½¿ç”¨promiseHijackæ—¶ï¼ŒmockApiè¢«æ‰§è¡Œäº†ä¸‰æ¬¡ï¼Œä¸‰æ¬¡promiseè¯·æ±‚çš„ç»“æœéƒ½ä¸ç›¸åŒ  
ä½¿ç”¨promiseHijackåï¼ŒmockApiä»…è¢«æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œä¸‰æ¬¡promiseè¯·æ±‚å…±ç”¨äº†é¦–ä¸ªpromiseçš„ç»“æœ  

## 3ç½‘é¡µå¦‚ä½•å”¤é†’æœ¬åœ°åº”ç”¨
é…ç½®è‡ªå®šä¹‰åè®®  
è¿™é‡Œæˆ‘ç”¨VS Codeæ¥ä¸¾ä¾‹å­ï¼Œæœ€ç»ˆæˆ‘è¦å®ç°é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆ‘ç”µè„‘ä¸Šçš„VS Codeã€‚ 
é¦–å…ˆé€šè¿‡æ³¨å†Œè¡¨æŸ¥æ‰¾
![avatar](../../../.vuepress/public/imgs/share/vscode-demo.png)
è¿™æ—¶ï¼Œæˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ vscode://open
![avatar](../../../.vuepress/public/imgs/share/vscode-demo2.png)

å¯ä»¥çœ‹åˆ°ï¼Œå°±åƒç™¾åº¦ç½‘ç›˜ä¸€æ ·ï¼Œæµè§ˆå™¨å¼¹å‡ºäº†è¯¢é—®å¯¹è¯æ¡†ï¼Œç„¶åå°±å¯ä»¥æ‰“å¼€VS Codeäº†ã€‚  
å¦‚æœæƒ³è¦åœ¨ç½‘é¡µä¸Šè¿›è¡Œæ‰“å¼€ï¼Œä¹Ÿç®€å•
```js
<script>
  function openVSCode() {
    window.location.href = 'vscode://open/';
  }
</script>
<button onclick="openVSCode()">æ‰“å¼€ VSCode</button>
```